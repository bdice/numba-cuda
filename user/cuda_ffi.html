

<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Calling foreign functions from Python kernels &#8212; Numba CUDA</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/nvidia-sphinx-theme.css?v=93085937" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user/cuda_ffi';</script>
    <link rel="icon" href="../_static/numba-green-icon-rgb.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compiling Python functions for use with other languages" href="cuda_compilation.html" />
    <link rel="prev" title="CUDA Bindings" href="bindings.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>


  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/nvidia-logo-horiz-rgb-blk-for-screen.svg" class="logo__image only-light" alt="Numba CUDA - Home"/>
    <script>document.write(`<img src="../_static/nvidia-logo-horiz-rgb-wht-for-screen.svg" class="logo__image only-dark" alt="Numba CUDA - Home"/>`);</script>
  
  
    <p class="title logo__title">Numba CUDA</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        


  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/nvidia-logo-horiz-rgb-blk-for-screen.svg" class="logo__image only-light" alt="Numba CUDA - Home"/>
    <script>document.write(`<img src="../_static/nvidia-logo-horiz-rgb-wht-for-screen.svg" class="logo__image only-dark" alt="Numba CUDA - Home"/>`);</script>
  
  
    <p class="title logo__title">Numba CUDA</p>
  
</a>


  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">


<nav class="bd-docs-nav bd-links"
     aria-label="Table of Contents">
  <p class="bd-links__title" role="heading" aria-level="1">Table of Contents</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">User guide</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernels.html">Writing CUDA Kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Memory management</a></li>
<li class="toctree-l2"><a class="reference internal" href="device-functions.html">Writing Device Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cudapysupported.html">Supported Python features in CUDA Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="fastmath.html">CUDA Fast Math</a></li>
<li class="toctree-l2"><a class="reference internal" href="intrinsics.html">Supported Atomic Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="cooperative_groups.html">Cooperative Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="random.html">Random Number Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="device-management.html">Device management</a></li>


<li class="toctree-l2"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="simulator.html">Debugging CUDA Python with the the CUDA Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="reduction.html">GPU Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="ufunc.html">CUDA Ufuncs and Generalized Ufuncs</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipc.html">Sharing CUDA Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_array_interface.html">CUDA Array Interface (Version 3)</a></li>
<li class="toctree-l2"><a class="reference internal" href="external-memory.html">External Memory Management (EMM) Plugin interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="bindings.html">CUDA Bindings</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Calling foreign functions from Python kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_compilation.html">Compiling Python functions for use with other languages</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html">On-disk Kernel Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="minor_version_compatibility.html">CUDA Minor Version Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html">CUDA Frequently Asked Questions</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">Reference documentation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/host.html">CUDA Host API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/kernel.html">CUDA Kernel API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/types.html">CUDA-Specific Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/memory.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/libdevice.html">Libdevice functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/envvars.html">Environment Variables</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>



      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Calling...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="calling-foreign-functions-from-python-kernels">
<span id="cuda-ffi"></span><h1>Calling foreign functions from Python kernels<a class="headerlink" href="#calling-foreign-functions-from-python-kernels" title="Link to this heading">#</a></h1>
<p>Python kernels can call device functions written in other languages. CUDA C/C++,
PTX, and binary objects (cubins, fat binaries, etc.) are directly supported;
sources in other languages must be compiled to PTX first. The constituent parts
of a Python kernel call to a foreign device function are:</p>
<ul class="simple">
<li><p>The device function implementation in a foreign language (e.g. CUDA C).</p></li>
<li><p>A declaration of the device function in Python.</p></li>
<li><p>A kernel that links with and calls the foreign function.</p></li>
</ul>
<section id="device-function-abi">
<span id="id1"></span><h2>Device function ABI<a class="headerlink" href="#device-function-abi" title="Link to this heading">#</a></h2>
<p>Numba’s ABI for calling device functions defines the following prototype in
C/C++:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">int</span>
<span class="n">function</span><span class="p">(</span>
<span class="w">  </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">return_value</span><span class="p">,</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Components of the prototype are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code> is used to prevent name-mangling so that it is easy to declare
the function in Python. It can be removed, but then the mangled name must be
used in the declaration of the function in Python.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__device__</span></code> is required to define the function as a device function.</p></li>
<li><p>The return value is always of type <code class="docutils literal notranslate"><span class="pre">int</span></code>, and is used to signal whether a
Python exception occurred. Since Python exceptions don’t occur in foreign
functions, this should always be set to 0 by the callee.</p></li>
<li><p>The first argument is a pointer to the return value of type <code class="docutils literal notranslate"><span class="pre">T</span></code>, which is
allocated in the local address space <a class="footnote-reference brackets" href="#f1" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> and passed in by the caller. If
the function returns a value, the pointee should be set by the callee to
store the return value.</p></li>
<li><p>Subsequent arguments should match the types and order of arguments passed to
the function from the Python kernel.</p></li>
</ul>
<p>Functions written in other languages must compile to PTX that conforms to this
prototype specification.</p>
<p>A function that accepts two floats and returns a float would have the following
prototype:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="n">__device__</span><span class="w"> </span><span class="kt">int</span>
<span class="n">mul_f32_f32</span><span class="p">(</span>
<span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">return_value</span><span class="p">,</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span>
<span class="p">);</span>
</pre></div>
</div>
<p class="rubric">Notes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Care must be taken to ensure that any operations on the return value
are applicable to data in the local address space.  Some operations,
such as atomics, cannot be performed on data in the local address
space.</p>
</aside>
</aside>
</section>
<section id="declaration-in-python">
<h2>Declaration in Python<a class="headerlink" href="#declaration-in-python" title="Link to this heading">#</a></h2>
<p>To declare a foreign device function in Python, use <a class="reference internal" href="#numba.cuda.declare_device" title="numba.cuda.declare_device"><code class="xref py py-func docutils literal notranslate"><span class="pre">declare_device()</span></code></a>:</p>
<dl class="py function">
<dt class="sig sig-object py" id="numba.cuda.declare_device">
<span class="sig-prename descclassname"><span class="pre">numba.cuda.</span></span><span class="sig-name descname"><span class="pre">declare_device</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sig</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#numba.cuda.declare_device" title="Link to this definition">#</a></dt>
<dd><p>Declare the signature of a foreign function. Returns a descriptor that can
be used to call the function from a Python kernel.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><em>str</em></a>) – The name of the foreign function.</p></li>
<li><p><strong>sig</strong> – The Numba signature of the function.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>The returned descriptor name need not match the name of the foreign function.
For example, when:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mul</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">declare_device</span><span class="p">(</span><span class="s1">&#39;mul_f32_f32&#39;</span><span class="p">,</span> <span class="s1">&#39;float32(float32, float32)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>is declared, calling <code class="docutils literal notranslate"><span class="pre">mul(a,</span> <span class="pre">b)</span></code> inside a kernel will translate into a call to
<code class="docutils literal notranslate"><span class="pre">mul_f32_f32(a,</span> <span class="pre">b)</span></code> in the compiled code.</p>
</section>
<section id="passing-pointers">
<h2>Passing pointers<a class="headerlink" href="#passing-pointers" title="Link to this heading">#</a></h2>
<p>Numba’s calling convention requires multiple values to be passed for array
arguments. These include the data pointer along with shape, stride, and other
information. This is incompatible with the expectations of most C/C++ functions,
which generally only expect a pointer to the data. To align the calling
conventions between C device code and Python kernels it is necessary to declare
array arguments using C pointer types.</p>
<p>For example, a function with the following prototype:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">numba/cuda/tests/doc_examples/ffi/functions.cu</span></code></span><a class="headerlink" href="#id3" title="Link to this code">#</a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="linenos">2</span><span class="n">__device__</span><span class="w"> </span><span class="kt">int</span>
<span class="linenos">3</span><span class="n">sum_reduce</span><span class="p">(</span>
<span class="linenos">4</span><span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">return_value</span><span class="p">,</span>
<span class="linenos">5</span><span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">array</span><span class="p">,</span>
<span class="linenos">6</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">7</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>would be declared as follows:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">from <code class="docutils literal notranslate"><span class="pre">test_ex_from_buffer</span></code> in <code class="docutils literal notranslate"><span class="pre">numba/cuda/tests/doc_examples/test_ffi.py</span></code></span><a class="headerlink" href="#id4" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">signature</span> <span class="o">=</span> <span class="s1">&#39;float32(CPointer(float32), int32)&#39;</span>
<span class="linenos">2</span><span class="n">sum_reduce</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">declare_device</span><span class="p">(</span><span class="s1">&#39;sum_reduce&#39;</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To obtain a pointer to array data for passing to foreign functions, use the
<code class="docutils literal notranslate"><span class="pre">from_buffer()</span></code> method of a <code class="docutils literal notranslate"><span class="pre">cffi.FFI</span></code> instance. For example, a kernel using
the <code class="docutils literal notranslate"><span class="pre">sum_reduce</span></code> function could be defined as:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">from <code class="docutils literal notranslate"><span class="pre">test_ex_from_buffer</span></code> in <code class="docutils literal notranslate"><span class="pre">numba/cuda/tests/doc_examples/test_ffi.py</span></code></span><a class="headerlink" href="#id5" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">import</span> <span class="nn">cffi</span>
<span class="linenos">2</span><span class="n">ffi</span> <span class="o">=</span> <span class="n">cffi</span><span class="o">.</span><span class="n">FFI</span><span class="p">()</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="p">[</span><span class="n">functions_cu</span><span class="p">])</span>
<span class="linenos">5</span><span class="k">def</span> <span class="nf">reduction_caller</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
<span class="linenos">6</span>    <span class="n">array_ptr</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="linenos">7</span>    <span class="n">result</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">sum_reduce</span><span class="p">(</span><span class="n">array_ptr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">result</span></code> and <code class="docutils literal notranslate"><span class="pre">array</span></code> are both arrays of <code class="docutils literal notranslate"><span class="pre">float32</span></code> data.</p>
</section>
<section id="linking-and-calling-functions">
<h2>Linking and Calling functions<a class="headerlink" href="#linking-and-calling-functions" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">link</span></code> keyword argument of the <a class="reference internal" href="../reference/kernel.html#numba.cuda.jit" title="numba.cuda.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;cuda.jit</span></code></a>
decorator accepts a list of file names specified by absolute path or a path
relative to the current working directory. Files whose name ends in <code class="docutils literal notranslate"><span class="pre">.cu</span></code>
will be compiled with the <a class="reference external" href="https://docs.nvidia.com/cuda/nvrtc/index.html">NVIDIA Runtime Compiler (NVRTC)</a> and linked into the kernel as
PTX; other files will be passed directly to the CUDA Linker.</p>
<p>For example, the following kernel calls the <code class="docutils literal notranslate"><span class="pre">mul()</span></code> function declared above
with the implementation <code class="docutils literal notranslate"><span class="pre">mul_f32_f32()</span></code> in a file called <code class="docutils literal notranslate"><span class="pre">functions.cu</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;functions.cu&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">multiply_vectors</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="c-c-support">
<h2>C/C++ Support<a class="headerlink" href="#c-c-support" title="Link to this heading">#</a></h2>
<p>Support for compiling and linking of CUDA C/C++ code is provided through the use
of NVRTC subject to the following considerations:</p>
<ul class="simple">
<li><p>It is only available when using the NVIDIA Bindings. See
<span class="target" id="index-0"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_CUDA_USE_NVIDIA_BINDING"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_CUDA_USE_NVIDIA_BINDING</span></code></a>.</p></li>
<li><p>A suitable version of the NVRTC library for the installed version of the
NVIDIA CUDA Bindings must be available.</p></li>
<li><p>The CUDA include path is assumed by default to be <code class="docutils literal notranslate"><span class="pre">/usr/local/cuda/include</span></code>
on Linux and <code class="docutils literal notranslate"><span class="pre">$env:CUDA_PATH\include</span></code> on Windows. It can be modified using
the environment variable <span class="target" id="index-1"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_CUDA_INCLUDE_PATH"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_CUDA_INCLUDE_PATH</span></code></a>.</p></li>
<li><p>The CUDA include directory will be made available to NVRTC on the include
path; additional includes are not supported.</p></li>
</ul>
</section>
<section id="complete-example">
<h2>Complete Example<a class="headerlink" href="#complete-example" title="Link to this heading">#</a></h2>
<p>This example demonstrates calling a foreign function written in CUDA C to
multiply pairs of numbers from two arrays.</p>
<p>The foreign function is written as follows:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">numba/cuda/tests/doc_examples/ffi/functions.cu</span></code></span><a class="headerlink" href="#id6" title="Link to this code">#</a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Foreign function example: multiplication of a pair of floats</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="n">__device__</span><span class="w"> </span><span class="kt">int</span>
<span class="linenos"> 4</span><span class="n">mul_f32_f32</span><span class="p">(</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">return_value</span><span class="p">,</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="p">{</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="c1">// Compute result and store in caller-provided slot</span>
<span class="linenos">10</span><span class="w">  </span><span class="o">*</span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">  </span><span class="c1">// Signal that no Python exception occurred</span>
<span class="linenos">13</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">14</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>The Python code and kernel are:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">from <code class="docutils literal notranslate"><span class="pre">test_ex_linking_cu</span></code> in <code class="docutils literal notranslate"><span class="pre">numba/cuda/tests/doc_examples/test_ffi.py</span></code></span><a class="headerlink" href="#id7" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cuda</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos"> 3</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="c1"># Declaration of the foreign function</span>
<span class="linenos"> 6</span><span class="n">mul</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">declare_device</span><span class="p">(</span><span class="s1">&#39;mul_f32_f32&#39;</span><span class="p">,</span> <span class="s1">&#39;float32(float32, float32)&#39;</span><span class="p">)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="c1"># Path to the source containing the foreign function</span>
<span class="linenos"> 9</span><span class="c1"># (here assumed to be in a subdirectory called &quot;ffi&quot;)</span>
<span class="linenos">10</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="linenos">11</span><span class="n">functions_cu</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;ffi&#39;</span><span class="p">,</span> <span class="s1">&#39;functions.cu&#39;</span><span class="p">)</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="c1"># Kernel that links in functions.cu and calls mul</span>
<span class="linenos">14</span><span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="p">[</span><span class="n">functions_cu</span><span class="p">])</span>
<span class="linenos">15</span><span class="k">def</span> <span class="nf">multiply_vectors</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="linenos">16</span>    <span class="n">i</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">17</span>
<span class="linenos">18</span>    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<span class="linenos">19</span>        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="c1"># Generate random data</span>
<span class="linenos">22</span><span class="n">N</span> <span class="o">=</span> <span class="mi">32</span>
<span class="linenos">23</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">24</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos">25</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos">26</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="c1"># Run the kernel</span>
<span class="linenos">29</span><span class="n">multiply_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">](</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="c1"># Sanity check - ensure the results match those expected</span>
<span class="linenos">32</span><span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The example above is minimal in order to illustrate a foreign function call -
it would not be expected to be particularly performant due to the small grid
and light workload of the foreign function.</p>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="bindings.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">CUDA Bindings</p>
      </div>
    </a>
    <a class="right-next"
       href="cuda_compilation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Compiling Python functions for use with other languages</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#device-function-abi">Device function ABI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#declaration-in-python">Declaration in Python</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numba.cuda.declare_device"><code class="docutils literal notranslate"><span class="pre">declare_device()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#passing-pointers">Passing pointers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linking-and-calling-functions">Linking and Calling functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-c-support">C/C++ Support</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-example">Complete Example</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
<a class="footer-brand logo" href="https://www.nvidia.com">
  <img src="../_static/nvidia-logo-horiz-rgb-1c-blk-for-screen.svg" class="logo__image only-light" alt="NVIDIA"/>
  <img src="../_static/nvidia-logo-horiz-rgb-1c-wht-for-screen.svg" class="logo__image only-dark" alt="NVIDIA"/>
</a></div>
      
        <div class="footer-item">

<div class="footer-links">
  
  
  <a class="external" href="https://www.nvidia.com/en-us/about-nvidia/privacy-policy/">Privacy Policy</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/about-nvidia/privacy-center/">Manage My Privacy</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/preferences/start/">Do Not Sell or Share My Data</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/about-nvidia/terms-of-service/">Terms of Service</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/about-nvidia/accessibility/">Accessibility</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/about-nvidia/company-policies/">Corporate Policies</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/product-security/">Product Security</a>
   | 
  
  
  
  <a class="external" href="https://www.nvidia.com/en-us/contact/">Contact</a>
  
  
  
</div>
</div>
      
        <div class="footer-item">


  <p class="copyright">
    
      Copyright © 2012-2024 Anaconda Inc. 2024, NVIDIA Corporation..
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>